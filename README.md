# SGCA - Sistema de Gest√£o Casa do Amor Backend

Sistema de gerenciamento backend para a Casa do Amor, desenvolvido em Spring Boot para controle de usu√°rios, pacientes e profissionais de sa√∫de com recursos avan√ßados de seguran√ßa.

![Spring Boot](https://img.shields.io/badge/Spring%20Boot-3.3.5-brightgreen)
![Java](https://img.shields.io/badge/Java-21-orange)
![MySQL](https://img.shields.io/badge/MySQL-8.0-blue)
![Docker](https://img.shields.io/badge/Docker-Supported-blue)
![Security](https://img.shields.io/badge/Security-JWT%20%2B%202FA-red)

## üìã √çndice

- [üîí Aviso de Seguran√ßa](#-aviso-de-seguran√ßa)
- [Vis√£o Geral](#vis√£o-geral)
- [Funcionalidades de Seguran√ßa](#funcionalidades-de-seguran√ßa)
- [Tecnologias](#tecnologias)
- [Pr√©-requisitos](#pr√©-requisitos)
- [Instala√ß√£o e Configura√ß√£o](#instala√ß√£o-e-configura√ß√£o)
- [Executando o Projeto](#executando-o-projeto)
- [API Documentation](#api-documentation)
- [Estrutura do Projeto](#estrutura-do-projeto)
- [Seguran√ßa e Autentica√ß√£o](#seguran√ßa-e-autentica√ß√£o)
- [Docker](#docker)
- [Banco de Dados](#banco-de-dados)
- [Testes](#testes)
- [Melhorias Futuras](#melhorias-futuras)
- [Contribui√ß√£o](#contribui√ß√£o)

## üîí Aviso de Seguran√ßa

‚ö†Ô∏è **IMPORTANTE**: Este projeto cont√©m arquivos de configura√ß√£o sens√≠veis.

- ‚ùå **NUNCA** commite o arquivo `.env` 
- ‚ùå **NUNCA** commite secrets (JWT_SECRET, senhas, tokens de API)
- ‚úÖ Use `.env.template` ou `.env.example` como refer√™ncia
- üîê Mantenha suas credenciais em seguran√ßa
- üîë Gere um JWT_SECRET √∫nico e forte para produ√ß√£o
- üìß Use senhas de aplicativo para configura√ß√£o de email

**Leia:** [SECURITY_NOTICE.md](SECURITY_NOTICE.md) para mais informa√ß√µes sobre pr√°ticas de seguran√ßa.

## üéØ Vis√£o Geral

O SGCA Backend √© uma API REST desenvolvida para gerenciar opera√ß√µes da Casa do Amor:

- **Autentica√ß√£o e Autoriza√ß√£o**: Sistema completo com JWT e 2FA
- **Gest√£o de Usu√°rios**: Controle de acesso por perfis (Admin, Recepcionista, etc.)
- **Pacientes**: Cadastro completo com dados pessoais, cl√≠nicos e endere√ßos
- **Profissionais de Sa√∫de**: Gest√£o de profissionais com documentos e especialidades
- **Upload de Arquivos**: Sistema de gerenciamento de fotos de perfil
- **Auditoria**: Rastreamento de sess√µes e tentativas de login

### Funcionalidades Principais

- ‚úÖ **Autentica√ß√£o JWT** com refresh tokens
- ‚úÖ **2FA (Two-Factor Authentication)** via email
- ‚úÖ **Recupera√ß√£o de senha** com tokens seguros
- ‚úÖ **Gerenciamento de sess√µes** ativas
- ‚úÖ **Rate limiting** para prote√ß√£o contra ataques
- ‚úÖ **Upload de arquivos** com valida√ß√£o de tipo e tamanho
- ‚úÖ **Migra√ß√£o de banco de dados** com Flyway
- ‚úÖ **API RESTful** com versionamento
- ‚úÖ **Documenta√ß√£o Swagger/OpenAPI** interativa
- ‚úÖ **Containeriza√ß√£o Docker** com multi-stage build
- ‚úÖ **Health checks** e monitoring com Spring Actuator
- ‚úÖ **CORS configurado** para integra√ß√£o frontend

## üõ°Ô∏è Funcionalidades de Seguran√ßa

### Autentica√ß√£o e Autoriza√ß√£o
- **JWT (JSON Web Tokens)** para autentica√ß√£o stateless
- **BCrypt** com for√ßa 12 para hashing de senhas
- **Autentica√ß√£o 2FA** opcional via c√≥digo por email
- **Controle de acesso baseado em roles** (RBAC)
- **Sess√µes rastreadas** com possibilidade de logout remoto

### Prote√ß√µes Implementadas
- **Rate Limiting** com Bucket4j para prevenir brute force
- **Bloqueio de conta** ap√≥s m√∫ltiplas tentativas falhas
- **Hist√≥rico de senhas** para prevenir reutiliza√ß√£o
- **Tokens de recupera√ß√£o** com expira√ß√£o e uso √∫nico
- **Valida√ß√£o de for√ßa de senha** com requisitos m√≠nimos
- **Ativa√ß√£o de conta** via email antes do primeiro login
- **Senhas tempor√°rias** para novos usu√°rios criados por admin

### Boas Pr√°ticas
- Container Docker executa com **usu√°rio n√£o-root**
- **Secrets gerenciados** via vari√°veis de ambiente
- **CORS restrito** a origens espec√≠ficas
- **Valida√ß√£o de entrada** em todos os endpoints
- **Tratamento centralizado de exce√ß√µes**

## üöÄ Tecnologias

### Backend
- **Java 21** - Linguagem de programa√ß√£o
- **Spring Boot 3.3.5** - Framework principal
- **Spring Security** - Autentica√ß√£o e autoriza√ß√£o
- **Spring Data JPA** - Persist√™ncia de dados
- **Spring Web** - API REST
- **Spring Mail** - Envio de emails
- **Hibernate** - ORM
- **Maven** - Gerenciamento de depend√™ncias
- **Lombok** - Redu√ß√£o de boilerplate

### Seguran√ßa
- **JWT (jjwt 0.12.6)** - Tokens de autentica√ß√£o
- **BCrypt** - Hashing de senhas
- **Bucket4j** - Rate limiting
- **Spring Security** - Framework de seguran√ßa

### Banco de Dados
- **MySQL 8.0** - Banco de dados relacional
- **Flyway** - Migra√ß√£o e versionamento de schema
- **HikariCP** - Pool de conex√µes de alta performance

### Documenta√ß√£o
- **SpringDoc OpenAPI 3** - Documenta√ß√£o autom√°tica da API
- **Swagger UI** - Interface interativa para testes

### DevOps
- **Docker & Docker Compose** - Containeriza√ß√£o
- **Multi-stage build** - Otimiza√ß√£o de imagens
- **Health checks** - Monitoramento de servi√ßos

## üìã Pr√©-requisitos

### Para execu√ß√£o local:
- Java 21 ou superior
- Maven 3.8+
- MySQL 8.0

### Para execu√ß√£o com Docker:
- Docker 20.10+
- Docker Compose 2.0+

## ‚öôÔ∏è Instala√ß√£o e Configura√ß√£o

### 1. Clone o reposit√≥rio
```bash
git clone https://github.com/chris-schettine/SGCA-CasaDoAmor-Backend.git
cd SGCA-CasaDoAmor-Backend
```

### 2. Configura√ß√£o do Banco de Dados (Local)

Crie o banco de dados MySQL:
```sql
CREATE DATABASE sgca CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'sgca_user'@'localhost' IDENTIFIED BY 'admin';
GRANT ALL PRIVILEGES ON sgca.* TO 'sgca_user'@'localhost';
FLUSH PRIVILEGES;
```

### 3. Configura√ß√£o das Vari√°veis de Ambiente

‚ö†Ô∏è **IMPORTANTE**: N√£o use as credenciais padr√£o em produ√ß√£o!

Copie o arquivo de exemplo e configure suas credenciais:
```bash
cp .env.example .env
```

Edite o arquivo `.env` com suas credenciais:
```bash
# Database
SGCA_DB_PASSWORD=sua_senha_segura_aqui
MYSQL_ROOT_PASSWORD=sua_senha_root_aqui
MYSQL_DATABASE=sgca
MYSQL_USER=sgca_user

# JWT - GERE UM SECRET FORTE E √öNICO!
# Use: echo -n "sua-frase-secreta-muito-longa" | base64
JWT_SECRET=sua_chave_base64_aqui
JWT_EXPIRATION=3600000

# Email Configuration
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=seu_email@gmail.com
SGCA_EMAIL_PASSWORD=sua_senha_de_app_aqui
```

### 4. Configura√ß√£o do application.properties

Certifique-se de que o `application.properties` usa vari√°veis de ambiente:
```properties
# Database
spring.datasource.url=jdbc:mysql://localhost:3306/sgca
spring.datasource.username=sgca_user
spring.datasource.password=${SGCA_DB_PASSWORD}

# JWT
jwt.secret=${JWT_SECRET}
jwt.expiration=${JWT_EXPIRATION:3600000}

# Email
spring.mail.host=${MAIL_HOST:smtp.gmail.com}
spring.mail.port=${MAIL_PORT:587}
spring.mail.username=${MAIL_USERNAME}
spring.mail.password=${SGCA_EMAIL_PASSWORD}
```

## üèÉ‚Äç‚ôÇÔ∏è Executando o Projeto

### Op√ß√£o 1: Execu√ß√£o Local

```bash
# Compilar o projeto
mvn clean compile

# Executar testes
mvn test

# Executar aplica√ß√£o
mvn spring-boot:run
```

A aplica√ß√£o estar√° dispon√≠vel em: `http://localhost:8080`

### Op√ß√£o 2: Docker (Recomendado)

```bash
# Construir e executar com Docker Compose
docker compose up --build -d

# Verificar status dos containers
docker compose ps

# Ver logs
docker compose logs -f sgca-backend
```

A aplica√ß√£o estar√° dispon√≠vel em: `http://localhost:8090`

### Op√ß√£o 3: Apenas Docker do Backend

```bash
# Build da imagem
docker build -t sgca-backend .

# Executar container
docker run -p 8080:8080 \
  -e SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3306/sgca \
  -e SPRING_DATASOURCE_USERNAME=sgca_user \
  -e SPRING_DATASOURCE_PASSWORD=admin \
  sgca-backend
```

## üìö API Documentation

### Swagger UI (Recomendado)
Acesse a documenta√ß√£o interativa:
- Local: `http://localhost:8080/docs`
- Docker: `http://localhost:8090/docs`

### Base URL
- Local: `http://localhost:8080`
- Docker: `http://localhost:8090`

### Health Check
```http
GET /actuator/health
```

### Autentica√ß√£o

Todos os endpoints (exceto p√∫blicos) requerem autentica√ß√£o via JWT.

#### Header de Autoriza√ß√£o
```http
Authorization: Bearer {seu_token_jwt}
```

### Endpoints P√∫blicos (Sem Autentica√ß√£o)

#### Autentica√ß√£o
```http
POST   /auth/register              # Registrar novo usu√°rio
POST   /auth/login                 # Login (retorna JWT)
POST   /auth/forgot-password       # Solicitar recupera√ß√£o de senha
POST   /auth/reset-password        # Redefinir senha com token
POST   /auth/verify-email          # Verificar email
POST   /auth/activate-account      # Ativar conta
POST   /auth/resend-activation     # Reenviar email de ativa√ß√£o
GET    /api/files/**               # Acessar arquivos p√∫blicos (fotos)
```

### Endpoints Autenticados

#### Autentica√ß√£o e Perfil
```http
POST   /auth/logout                # Logout da sess√£o atual
POST   /auth/logout-all            # Logout de todas as sess√µes
GET    /auth/sessions              # Listar sess√µes ativas
DELETE /auth/sessions/{token}      # Encerrar sess√£o espec√≠fica
POST   /auth/change-password       # Alterar senha
```

#### Two-Factor Authentication (2FA)
```http
POST   /auth/2fa/setup             # Configurar 2FA
POST   /auth/2fa/enable            # Habilitar/Desabilitar 2FA
POST   /auth/2fa/verify            # Verificar c√≥digo 2FA no login
POST   /auth/2fa/disable           # Desabilitar 2FA
```

#### Pacientes (Requer autentica√ß√£o)
```http
POST   /pacientes                  # Criar paciente
GET    /pacientes                  # Listar pacientes
GET    /pacientes/{id}             # Buscar por ID
PUT    /pacientes/{id}             # Atualizar paciente
DELETE /pacientes/{id}             # Deletar paciente
```

#### Upload de Arquivos
```http
POST   /api/files/upload           # Upload de foto (multipart/form-data)
GET    /api/files/{filename}       # Acessar arquivo
```

#### Admin (Requer role ADMINISTRADOR)
```http
GET    /admin/usuarios             # Listar todos usu√°rios
POST   /admin/usuarios             # Criar usu√°rio (com senha tempor√°ria)
PUT    /admin/usuarios/{id}        # Atualizar usu√°rio
DELETE /admin/usuarios/{id}        # Deletar usu√°rio
POST   /admin/usuarios/{id}/reset-password  # Resetar senha
GET    /admin/perfis               # Listar perfis
POST   /admin/perfis               # Criar perfil
POST   /admin/usuarios/{id}/perfis # Atribuir perfil a usu√°rio
```

### Exemplo de Requisi√ß√£o: Login

```bash
# 1. Login
curl -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "cpf": "12345678900",
    "senha": "SuaSenha123!"
  }'

# Resposta:
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "tipo": "Bearer",
  "email": "usuario@example.com",
  "nome": "Nome do Usu√°rio",
  "tipoUsuario": "RECEPCIONISTA",
  "expiresIn": 3600000,
  "requires2FA": false
}

# 2. Usar o token em requisi√ß√µes
curl -X GET http://localhost:8080/pacientes \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### Exemplo de Requisi√ß√£o: Criar Paciente

```bash
curl -X POST http://localhost:8080/pacientes \
  -H "Authorization: Bearer {seu_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "dadoPessoal": {
      "nome": "Jo√£o Silva",
      "cpf": "12345678900",
      "dataNascimento": "1990-01-01",
      "telefone": "(11) 99999-9999",
      "email": "joao@email.com"
    },
    "endereco": {
      "logradouro": "Rua das Flores",
      "numero": 123,
      "bairro": "Centro",
      "cidade": "S√£o Paulo",
      "estado": "SP",
      "cep": "01234567"
    },
    "dadoClinico": {
      "diagnostico": "Hipertens√£o",
      "tratamento": "Medica√ß√£o cont√≠nua",
      "usaSonda": false,
      "usaCurativo": false
    }
  }'
```

## üìÅ Estrutura do Projeto

```
src/main/java/br/com/casadoamor/sgca/
‚îú‚îÄ‚îÄ SgcaBackendApplication.java     # Classe principal
‚îú‚îÄ‚îÄ annotation/                     # Anota√ß√µes customizadas
‚îÇ   ‚îî‚îÄ‚îÄ RateLimit.java             # Anota√ß√£o para rate limiting
‚îú‚îÄ‚îÄ aspect/                         # Aspectos AOP
‚îÇ   ‚îî‚îÄ‚îÄ RateLimitAspect.java       # Implementa√ß√£o de rate limiting
‚îú‚îÄ‚îÄ config/                         # Configura√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ SecurityConfig.java        # Configura√ß√£o Spring Security
‚îÇ   ‚îú‚îÄ‚îÄ SwaggerConfig.java         # Configura√ß√£o OpenAPI/Swagger
‚îÇ   ‚îî‚îÄ‚îÄ exception/                 # Tratamento global de exce√ß√µes
‚îÇ       ‚îú‚îÄ‚îÄ GlobalExceptionHandler.java
‚îÇ       ‚îú‚îÄ‚îÄ CustomError.java
‚îÇ       ‚îî‚îÄ‚îÄ RateLimitExceededException.java
‚îú‚îÄ‚îÄ controller/                     # Controllers REST
‚îÇ   ‚îú‚îÄ‚îÄ admin/                     # Endpoints administrativos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AdminController.java
‚îÇ   ‚îú‚îÄ‚îÄ auth/                      # Autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthController.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TwoFactorController.java
‚îÇ   ‚îú‚îÄ‚îÄ file/                      # Upload de arquivos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FileController.java
‚îÇ   ‚îî‚îÄ‚îÄ paciente/                  # Gest√£o de pacientes
‚îÇ       ‚îî‚îÄ‚îÄ PacienteController.java
‚îú‚îÄ‚îÄ dto/                           # Data Transfer Objects
‚îÇ   ‚îú‚îÄ‚îÄ admin/                     # DTOs administrativos
‚îÇ   ‚îú‚îÄ‚îÄ auth/                      # DTOs de autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ common/                    # DTOs comuns
‚îÇ   ‚îú‚îÄ‚îÄ paciente/                  # DTOs de pacientes
‚îÇ   ‚îî‚îÄ‚îÄ twofactor/                 # DTOs de 2FA
‚îú‚îÄ‚îÄ entity/                        # Entidades JPA
‚îÇ   ‚îú‚îÄ‚îÄ admin/                     # Entidades administrativas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthUsuario.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Perfil.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SessaoUsuario.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HistoricoSenha.java
‚îÇ   ‚îú‚îÄ‚îÄ auth/                      # Entidades de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TentativaLogin.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TokenRecuperacao.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Autenticacao2FA.java
‚îÇ   ‚îú‚îÄ‚îÄ common/                    # Entidades comuns
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BaseEntity.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DadoPessoal.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Endereco.java
‚îÇ   ‚îî‚îÄ‚îÄ paciente/                  # Entidades de pacientes
‚îÇ       ‚îú‚îÄ‚îÄ Paciente.java
‚îÇ       ‚îî‚îÄ‚îÄ DadoClinico.java
‚îú‚îÄ‚îÄ enums/                         # Enumera√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ TipoUsuarioEnum.java
‚îÇ   ‚îú‚îÄ‚îÄ TipoToken.java
‚îÇ   ‚îî‚îÄ‚îÄ EstadoEnum.java
‚îú‚îÄ‚îÄ exception/                     # Exce√ß√µes customizadas
‚îÇ   ‚îî‚îÄ‚îÄ ResourceNotFoundException.java
‚îú‚îÄ‚îÄ mapper/                        # Mapeadores (Entity <-> DTO)
‚îú‚îÄ‚îÄ repository/                    # Reposit√≥rios JPA
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îî‚îÄ‚îÄ paciente/
‚îú‚îÄ‚îÄ security/                      # Componentes de seguran√ßa
‚îÇ   ‚îú‚îÄ‚îÄ JwtUtil.java              # Utilit√°rio JWT
‚îÇ   ‚îú‚îÄ‚îÄ JwtAuthenticationFilter.java  # Filtro JWT
‚îÇ   ‚îî‚îÄ‚îÄ UserDetailsServiceImpl.java   # Carregamento de usu√°rios
‚îú‚îÄ‚îÄ service/                       # Servi√ßos de neg√≥cio
‚îÇ   ‚îú‚îÄ‚îÄ admin/                     # Servi√ßos administrativos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserManagementService.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PerfilService.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SessaoService.java
‚îÇ   ‚îú‚îÄ‚îÄ auth/                      # Servi√ßos de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthService.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RecuperacaoSenhaService.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TwoFactorService.java
‚îÇ   ‚îú‚îÄ‚îÄ common/                    # Servi√ßos comuns
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmailService.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FileStorageService.java
‚îÇ   ‚îî‚îÄ‚îÄ paciente/
‚îÇ       ‚îî‚îÄ‚îÄ PacienteService.java
‚îî‚îÄ‚îÄ util/                          # Utilit√°rios
    ‚îî‚îÄ‚îÄ PasswordValidator.java     # Valida√ß√£o de senhas

src/main/resources/
‚îú‚îÄ‚îÄ application.properties          # Configura√ß√£o principal
‚îú‚îÄ‚îÄ application-docker.properties   # Configura√ß√£o para Docker
‚îú‚îÄ‚îÄ application-test.properties     # Configura√ß√£o para testes
‚îî‚îÄ‚îÄ db/migration/                   # Migra√ß√µes Flyway
    ‚îú‚îÄ‚îÄ V01__create_tables.sql
    ‚îú‚îÄ‚îÄ V02__create_tables.sql
    ‚îú‚îÄ‚îÄ V03__create_autenticacao_2fa.sql
    ‚îú‚îÄ‚îÄ V04__add_senha_temporaria.sql
    ‚îî‚îÄ‚îÄ V05__add_foto_columns.sql
```

## ÔøΩ Seguran√ßa e Autentica√ß√£o

### Fluxo de Autentica√ß√£o

1. **Registro** ‚Üí Usu√°rio se registra com CPF e senha
2. **Ativa√ß√£o** ‚Üí Email de ativa√ß√£o √© enviado
3. **Login** ‚Üí Usu√°rio faz login com CPF e senha
4. **2FA (Opcional)** ‚Üí Se habilitado, c√≥digo √© enviado por email
5. **Token JWT** ‚Üí Token √© retornado para uso em requisi√ß√µes

### Configura√ß√£o de Seguran√ßa

#### Requisitos de Senha
- M√≠nimo 8 caracteres
- Pelo menos 1 letra mai√∫scula
- Pelo menos 1 letra min√∫scula
- Pelo menos 1 n√∫mero
- Pelo menos 1 caractere especial
- N√£o pode ser reutilizada (√∫ltimas 5 senhas)

#### BCrypt Hashing
```java
// For√ßa 12 (recomendado para dados de sa√∫de)
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder(12);
```

#### JWT Configuration
```properties
jwt.secret=${JWT_SECRET}          # Base64 encoded secret
jwt.expiration=3600000             # 1 hora em milissegundos
```

#### Rate Limiting
```java
@RateLimit(requests = 5, window = 60)  // 5 requisi√ß√µes por minuto
public ResponseEntity<?> login(...) { ... }
```

### Roles e Permiss√µes

| Role | Descri√ß√£o | Permiss√µes |
|------|-----------|------------|
| **ADMINISTRADOR** | Acesso total ao sistema | Gerenciar usu√°rios, perfis, todas as opera√ß√µes |
| **RECEPCIONISTA** | Opera√ß√µes do dia-a-dia | Criar/editar pacientes, visualizar dados |
| **PROFISSIONAL_SAUDE** | Profissional de sa√∫de | Acessar dados cl√≠nicos, atualizar tratamentos |

### Prote√ß√µes Implementadas

#### Bloqueio de Conta
- 5 tentativas falhas de login ‚Üí Conta bloqueada
- Desbloqueio via email ou por administrador

#### Sess√µes
- Rastreamento de todas as sess√µes ativas
- Logout remoto de sess√µes espec√≠ficas
- Logout de todas as sess√µes simultaneamente

#### Tokens de Recupera√ß√£o
- Validade de 1 hora
- Uso √∫nico (invalidado ap√≥s uso)
- Todos os tokens anteriores s√£o invalidados ao gerar novo

## üê≥ Docker

### Arquivo docker-compose.yml

O projeto inclui configura√ß√£o completa com:
- **MySQL 8.0** na porta 3316 (externa) ‚Üí 3306 (interna)
- **Backend Spring Boot** na porta 8090 (externa) ‚Üí 8080 (interna)
- **Rede dedicada** (sgca-network)
- **Volumes persistentes** para dados do MySQL e uploads
- **Health checks** configurados
- **Usu√°rio n√£o-root** no container do backend

### Comandos Docker √öteis

```bash
# Iniciar todos os servi√ßos
docker compose up -d

# Iniciar com rebuild (ap√≥s mudan√ßas no c√≥digo)
docker compose up --build -d

# Parar todos os servi√ßos
docker compose down

# Ver logs em tempo real
docker compose logs -f

# Ver logs espec√≠ficos
docker compose logs mysql
docker compose logs sgca

# Verificar status dos containers
docker compose ps

# Acessar container MySQL
docker exec -it mysql_sgca mysql -u sgca_user -p sgca

# Acessar shell do container backend
docker exec -it spring_sgca sh

# Rebuild completo (remove containers e imagens)
docker compose down
docker compose build --no-cache
docker compose up -d

# Limpar volumes (‚ö†Ô∏è CUIDADO: remove dados!)
docker compose down -v
```

### Portas Utilizadas

| Servi√ßo | Porta Interna | Porta Externa | Descri√ß√£o |
|---------|---------------|---------------|-----------|
| MySQL | 3306 | 3316 | Banco de dados |
| Backend | 8080 | 8090 | API REST |

### Vari√°veis de Ambiente Docker

Configuradas no arquivo `.env`:
```env
# MySQL
MYSQL_DATABASE=sgca
MYSQL_USER=sgca_user
SGCA_DB_PASSWORD=sua_senha_aqui
MYSQL_ROOT_PASSWORD=sua_senha_root_aqui

# Email
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=seu_email@gmail.com
SGCA_EMAIL_PASSWORD=sua_senha_de_app_aqui
```

## üóÑÔ∏è Banco de Dados

### Gerenciamento de Schema

O projeto usa **Flyway** para versionamento e migra√ß√£o do banco de dados.

#### Arquivos de Migra√ß√£o
```
src/main/resources/db/migration/
‚îú‚îÄ‚îÄ V01__create_tables.sql              # Tabelas principais
‚îú‚îÄ‚îÄ V02__create_tables.sql              # Tabelas adicionais
‚îú‚îÄ‚îÄ V03__create_autenticacao_2fa.sql    # Suporte a 2FA
‚îú‚îÄ‚îÄ V04__add_senha_temporaria.sql       # Senhas tempor√°rias
‚îî‚îÄ‚îÄ V05__add_foto_columns.sql           # Colunas para fotos
```

### Principais Tabelas

#### auth_usuario
Armazena usu√°rios do sistema com autentica√ß√£o
```sql
CREATE TABLE auth_usuario (
  id CHAR(36) PRIMARY KEY,
  cpf VARCHAR(11) UNIQUE NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  senha_hash VARCHAR(255) NOT NULL,
  tipo VARCHAR(50) NOT NULL,  -- ADMINISTRADOR, RECEPCIONISTA, etc.
  ativo BOOLEAN DEFAULT TRUE,
  conta_bloqueada BOOLEAN DEFAULT FALSE,
  senha_temporaria BOOLEAN DEFAULT FALSE,
  requer_2fa BOOLEAN DEFAULT FALSE,
  email_verificado BOOLEAN DEFAULT FALSE,
  ...
);
```

#### dados_pessoais
Dados pessoais de indiv√≠duos
```sql
CREATE TABLE dados_pessoais (
  id CHAR(36) PRIMARY KEY,
  nome VARCHAR(255) NOT NULL,
  cpf VARCHAR(11) UNIQUE NOT NULL,
  data_nascimento DATE,
  rg VARCHAR(10),
  telefone VARCHAR(255),
  foto_url VARCHAR(500),
  ...
);
```

#### pacientes
Informa√ß√µes de pacientes
```sql
CREATE TABLE pacientes (
  id CHAR(36) PRIMARY KEY,
  dado_pessoal_id CHAR(36),
  endereco_id CHAR(36),
  FOREIGN KEY (dado_pessoal_id) REFERENCES dados_pessoais(id),
  FOREIGN KEY (endereco_id) REFERENCES enderecos(id)
);
```

#### dados_clinicos
Dados cl√≠nicos dos pacientes
```sql
CREATE TABLE dados_clinicos (
  id CHAR(36) PRIMARY KEY,
  diagnostico VARCHAR(255),
  tratamento VARCHAR(255),
  usa_sonda BOOLEAN NOT NULL,
  tipo_sonda VARCHAR(255),
  usa_curativo BOOLEAN NOT NULL,
  paciente_id CHAR(36) NOT NULL,
  FOREIGN KEY (paciente_id) REFERENCES pacientes(id)
);
```

#### sessao_usuario
Rastreamento de sess√µes ativas
```sql
CREATE TABLE sessao_usuario (
  id CHAR(36) PRIMARY KEY,
  usuario_id CHAR(36) NOT NULL,
  token_jwt TEXT NOT NULL,
  ip_address VARCHAR(45),
  user_agent VARCHAR(500),
  data_login TIMESTAMP NOT NULL,
  data_expiracao TIMESTAMP NOT NULL,
  ativa BOOLEAN DEFAULT TRUE,
  ...
);
```

#### tentativa_login
Registro de tentativas de login (para bloqueio)
```sql
CREATE TABLE tentativa_login (
  id CHAR(36) PRIMARY KEY,
  cpf VARCHAR(11) NOT NULL,
  sucesso BOOLEAN NOT NULL,
  ip_address VARCHAR(45),
  data_tentativa TIMESTAMP NOT NULL,
  ...
);
```

### Configura√ß√£o Flyway

```properties
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.locations=classpath:db/migration
```

### Backup e Restore

#### Backup
```bash
# Via Docker
docker exec mysql_sgca mysqldump -u sgca_user -p sgca > backup_sgca_$(date +%Y%m%d).sql

# Local
mysqldump -u sgca_user -p sgca > backup_sgca_$(date +%Y%m%d).sql
```

#### Restore
```bash
# Via Docker
docker exec -i mysql_sgca mysql -u sgca_user -p sgca < backup_sgca_20251017.sql

# Local
mysql -u sgca_user -p sgca < backup_sgca_20251017.sql
```

## üß™ Testes

### Executar Testes

```bash
# Executar todos os testes
mvn test

# Executar com relat√≥rio de cobertura
mvn test jacoco:report

# Executar testes espec√≠ficos
mvn test -Dtest=JwtUtilTest
mvn test -Dtest=AuthControllerTest

# Pular testes durante build
mvn package -DskipTests

# Executar testes com perfil espec√≠fico
mvn test -Dspring.profiles.active=test
```

### Cobertura de Testes

O projeto inclui testes para:

#### Seguran√ßa
- ‚úÖ `JwtUtilTest` - Gera√ß√£o e valida√ß√£o de tokens JWT
- ‚úÖ `UserDetailsServiceImplTest` - Carregamento de usu√°rios

#### Controllers
- ‚úÖ `AuthControllerTest` - Endpoints de autentica√ß√£o
- ‚úÖ `TwoFactorControllerTest` - Endpoints de 2FA
- ‚úÖ `FileControllerTest` - Upload e download de arquivos

#### Aspectos
- ‚úÖ `RateLimitAspectTest` - Valida√ß√£o de rate limiting

#### Utilit√°rios
- ‚úÖ `PasswordValidatorTest` - Valida√ß√£o de senhas

#### Exception Handling
- ‚úÖ `GlobalExceptionHandlerTest` - Tratamento de exce√ß√µes

### Teste Manual da API

Use os scripts inclu√≠dos para testar endpoints:

```bash
# Linux/Mac
chmod +x test-api.sh test-email.sh
./test-api.sh
./test-email.sh

# Windows PowerShell
.\test-api.sh
.\test-email.sh
```

### Postman/Insomnia Collection

Importe a cole√ß√£o de exemplos (se dispon√≠vel) ou use o Swagger UI para testes interativos:
```
http://localhost:8080/docs
```

## üîß Melhorias Futuras

### Seguran√ßa
- [ ] Implementar refresh tokens para renova√ß√£o autom√°tica
- [ ] Adicionar autentica√ß√£o via OAuth2/SSO (Google, Microsoft)
- [ ] Implementar CAPTCHA para prevenir bots
- [ ] Adicionar auditoria completa (quem alterou o qu√™ e quando)
- [ ] Implementar criptografia de dados sens√≠veis no banco
- [ ] Adicionar detec√ß√£o de dispositivos suspeitos

### Performance
- [ ] Adicionar cache com Redis para sess√µes
- [ ] Implementar pagina√ß√£o em todos os endpoints de listagem
- [ ] Otimizar queries com √≠ndices adicionais
- [ ] Implementar lazy loading para relacionamentos JPA
- [ ] Adicionar compress√£o de respostas HTTP

### Funcionalidades
- [ ] Sistema de notifica√ß√µes push
- [ ] Exporta√ß√£o de relat√≥rios em PDF/Excel
- [ ] Dashboard com estat√≠sticas e gr√°ficos
- [ ] Agendamento de consultas
- [ ] Hist√≥rico m√©dico completo
- [ ] Integra√ß√£o com sistemas de prontu√°rio eletr√¥nico

### DevOps
- [ ] CI/CD com GitHub Actions
- [ ] An√°lise de c√≥digo com SonarQube
- [ ] Monitoramento com Prometheus + Grafana
- [ ] Logging centralizado com ELK Stack
- [ ] Testes de carga com JMeter
- [ ] Deploy em Kubernetes

### Testes
- [ ] Aumentar cobertura de testes para >80%
- [ ] Adicionar testes de integra√ß√£o end-to-end
- [ ] Implementar testes de performance
- [ ] Adicionar testes de seguran√ßa (OWASP)
- [ ] Testes de regress√£o automatizados

### Documenta√ß√£o
- [ ] Adicionar diagramas de arquitetura
- [ ] Documentar fluxos de processo
- [ ] Criar guia de contribui√ß√£o detalhado
- [ ] Adicionar exemplos de c√≥digo
- [ ] V√≠deos tutoriais para setup

## üîß Configura√ß√µes de Ambiente

### Profiles Dispon√≠veis

- **default**: Desenvolvimento local com MySQL
- **docker**: Execu√ß√£o em container Docker
- **test**: Testes com H2 em mem√≥ria (se configurado)

### Vari√°veis de Ambiente Completas

```env
# Database
SGCA_DB_PASSWORD=sua_senha_segura
MYSQL_ROOT_PASSWORD=senha_root_segura
MYSQL_DATABASE=sgca
MYSQL_USER=sgca_user

# JWT
JWT_SECRET=sua_chave_base64_muito_longa_e_segura
JWT_EXPIRATION=3600000

# Email
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=seu_email@gmail.com
SGCA_EMAIL_PASSWORD=senha_de_aplicativo_do_gmail

# File Upload
FILE_UPLOAD_DIR=uploads
FILE_UPLOAD_BASE_URL=http://localhost:8080/api/files
SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE=5MB
SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE=5MB

# Password History
PASSWORD_HISTORY_CHECK_LAST=5

# Server
SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=default
```

### Como Gerar JWT_SECRET Seguro

```bash
# Linux/Mac
echo -n "sua-frase-secreta-muito-longa-e-unica-aqui" | base64

# Windows PowerShell
[Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes("sua-frase-secreta-muito-longa-e-unica-aqui"))

# Online (n√£o recomendado para produ√ß√£o)
# https://www.base64encode.org/
```

## ü§ù Contribui√ß√£o

Contribui√ß√µes s√£o bem-vindas! Por favor, siga estas diretrizes:

### Como Contribuir

1. **Fork** o projeto
2. Crie uma **branch** para sua feature (`git checkout -b feature/MinhaFeature`)
3. **Commit** suas mudan√ßas (`git commit -m 'feat: Adiciona MinhaFeature'`)
4. **Push** para a branch (`git push origin feature/MinhaFeature`)
5. Abra um **Pull Request**

### Padr√µes de C√≥digo

#### Conven√ß√µes Java
- Seguir conven√ß√µes Java/Spring Boot
- Usar Lombok para reduzir boilerplate
- Documentar m√©todos p√∫blicos com JavaDoc
- Nomear vari√°veis de forma descritiva

#### Commits Sem√¢nticos
```
feat: Nova funcionalidade
fix: Corre√ß√£o de bug
docs: Altera√ß√£o em documenta√ß√£o
style: Formata√ß√£o, ponto e v√≠rgula faltando, etc
refactor: Refatora√ß√£o de c√≥digo
test: Adi√ß√£o ou corre√ß√£o de testes
chore: Atualiza√ß√£o de depend√™ncias, configura√ß√µes, etc
```

Exemplos:
```bash
git commit -m "feat: Adiciona endpoint de relat√≥rios"
git commit -m "fix: Corrige valida√ß√£o de CPF"
git commit -m "docs: Atualiza README com exemplos de API"
```

#### Testes
- Escrever testes para novas funcionalidades
- Manter cobertura de testes > 70%
- Executar testes antes de fazer commit
- Incluir testes unit√°rios e de integra√ß√£o

#### Code Review
- Revisar c√≥digo antes de submeter PR
- Responder a coment√°rios do review
- Garantir que o CI passa antes de merge

### Reportar Bugs

Ao reportar bugs, inclua:
- Descri√ß√£o clara do problema
- Passos para reproduzir
- Comportamento esperado vs. atual
- Screenshots (se aplic√°vel)
- Vers√£o do Java, Spring Boot, etc.

### Sugerir Melhorias

- Descreva a melhoria proposta
- Explique o benef√≠cio
- Forne√ßa exemplos de uso

## üìù Changelog

### [0.0.1-SNAPSHOT] - 2025-10-17

#### ‚ú® Added
- Sistema completo de autentica√ß√£o com JWT
- Autentica√ß√£o de dois fatores (2FA) via email
- Recupera√ß√£o de senha com tokens seguros
- Gerenciamento de sess√µes ativas
- Upload de arquivos (fotos de perfil)
- Rate limiting para prote√ß√£o contra ataques
- Valida√ß√£o de for√ßa de senha
- Hist√≥rico de senhas para prevenir reutiliza√ß√£o
- Bloqueio de conta ap√≥s tentativas falhas
- Ativa√ß√£o de conta via email
- Senhas tempor√°rias para novos usu√°rios
- CRUD completo para pacientes
- Gest√£o de profissionais de sa√∫de
- Migra√ß√£o de banco com Flyway
- Documenta√ß√£o interativa com Swagger
- Containeriza√ß√£o com Docker
- Health checks e monitoring
- Configura√ß√£o CORS
- Suporte a m√∫ltiplos perfis de usu√°rio

#### üîí Security
- ‚úÖ BCrypt password hashing (for√ßa 12)
- ‚úÖ JWT com chave configur√°vel
- ‚úÖ Spring Security configurado
- ‚úÖ Rate limiting implementado
- ‚úÖ Valida√ß√£o de entrada
- ‚úÖ Container n√£o-root
- ‚úÖ Prote√ß√£o CSRF desabilitada (API stateless)
- ‚úÖ Sess√µes stateless

#### üêõ Known Issues
- Deprecated methods em alguns testes (getStatusCodeValue)
- Alguns imports n√£o utilizados
- Docker base image tem 1 vulnerabilidade alta (requer atualiza√ß√£o)

### [Planejado] - Pr√≥xima Vers√£o

#### üöÄ Planned Features
- Refresh tokens
- OAuth2/SSO
- Cache com Redis
- Exporta√ß√£o de relat√≥rios
- Dashboard administrativo
- Notifica√ß√µes push
- Testes de integra√ß√£o E2E

## üìû Suporte

Para d√∫vidas, problemas ou sugest√µes:

### üêõ Issues
- Reporte bugs via [GitHub Issues](https://github.com/chris-schettine/SGCA-CasaDoAmor-Backend/issues)
- Use labels apropriadas: `bug`, `enhancement`, `question`, `documentation`

### üí¨ Discuss√µes
- Participe das [GitHub Discussions](https://github.com/chris-schettine/SGCA-CasaDoAmor-Backend/discussions)

### üìß Contato
- Email: contato@casadoamor.com.br

## üìÑ Licen√ßa

Este projeto est√° sob licen√ßa MIT. Veja o arquivo [LICENSE](LICENSE) para detalhes.

---

## üöÄ Quick Start

```bash
# 1. Clone o reposit√≥rio
git clone https://github.com/chris-schettine/SGCA-CasaDoAmor-Backend.git
cd SGCA-CasaDoAmor-Backend

# 2. Configure as vari√°veis de ambiente
cp .env.example .env
# Edite .env com suas credenciais

# 3. Execute com Docker (recomendado)
docker compose up -d

# 4. Verifique se est√° rodando
curl http://localhost:8090/actuator/health

# 5. Acesse a documenta√ß√£o interativa
# http://localhost:8090/docs
```

**üéâ Aplica√ß√£o rodando em http://localhost:8090**

---

## üìä Status do Projeto

![Status](https://img.shields.io/badge/Status-Em%20Desenvolvimento-yellow)
![Vers√£o](https://img.shields.io/badge/Vers%C3%A3o-0.0.1--SNAPSHOT-blue)
![Cobertura](https://img.shields.io/badge/Cobertura%20de%20Testes-~70%25-green)
![Licen√ßa](https://img.shields.io/badge/Licen%C3%A7a-MIT-blue)

### Pr√≥ximos Passos
- [ ] Implementar refresh tokens
- [ ] Adicionar testes de integra√ß√£o E2E
- [ ] Configurar CI/CD com GitHub Actions
- [ ] Deploy em ambiente de produ√ß√£o
- [ ] Documenta√ß√£o de arquitetura detalhada

---

**Desenvolvido com ‚ù§Ô∏è para Casa do Amor**