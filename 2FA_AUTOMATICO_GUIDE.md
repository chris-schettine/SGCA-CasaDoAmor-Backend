# Guia: Ativa√ß√£o Autom√°tica de 2FA com Rate Limiting

## üìã Vis√£o Geral

Este documento descreve a implementa√ß√£o da **ativa√ß√£o autom√°tica de autentica√ß√£o de dois fatores (2FA)** durante o processo de ativa√ß√£o de conta, incluindo prote√ß√£o contra envio excessivo de c√≥digos atrav√©s de **rate limiting**.

## üéØ Objetivos

1. **Ativar 2FA automaticamente** quando o usu√°rio ativa sua conta
2. **Enviar c√≥digo inicial** imediatamente ap√≥s ativa√ß√£o
3. **Solicitar c√≥digo no pr√≥ximo login** automaticamente
4. **Proteger contra abuso** com rate limiting em m√∫ltiplos n√≠veis

## üîÑ Fluxo Completo

### 1. Cria√ß√£o de Usu√°rio (Admin)
```
Admin ‚Üí POST /admin/users
      ‚Üí Sistema cria usu√°rio com senha tempor√°ria
      ‚Üí Envia email de ativa√ß√£o
```

### 2. Ativa√ß√£o de Conta (Usu√°rio)
```
Usu√°rio ‚Üí POST /auth/activate
        ‚îú‚îÄ Valida token e senha tempor√°ria
        ‚îú‚îÄ Define nova senha
        ‚îú‚îÄ Marca email como verificado
        ‚îú‚îÄ Ativa conta
        ‚îú‚îÄ üÜï ATIVA 2FA AUTOMATICAMENTE
        ‚îî‚îÄ üÜï ENVIA C√ìDIGO 2FA INICIAL
```

### 3. Login com 2FA (Usu√°rio)
```
Usu√°rio ‚Üí POST /auth/login
        ‚îú‚îÄ Valida CPF e senha
        ‚îú‚îÄ Detecta 2FA habilitado
        ‚îú‚îÄ Envia c√≥digo por email
        ‚îî‚îÄ Retorna: { requires2FA: true, userId: xxx }
```

### 4. Verifica√ß√£o 2FA (Usu√°rio)
```
Usu√°rio ‚Üí POST /auth/2fa/verify
        ‚îú‚îÄ Valida c√≥digo de 6 d√≠gitos
        ‚îú‚îÄ Verifica expira√ß√£o (5 minutos)
        ‚îî‚îÄ Retorna JWT token
```

## üõ°Ô∏è Rate Limiting

### Limites Implementados

| Janela de Tempo | Limite M√°ximo | A√ß√£o ao Exceder |
|----------------|---------------|-----------------|
| **15 minutos** | 3 c√≥digos | Bloqueio tempor√°rio |
| **1 hora** | 5 c√≥digos | Bloqueio tempor√°rio |
| **1 dia** | 10 c√≥digos | Bloqueio tempor√°rio |
| **Intervalo m√≠nimo** | 60 segundos | Erro de espera |

### Mensagens de Erro

Quando o limite √© excedido, o usu√°rio recebe:
```
"Limite de envios excedido. Por favor, aguarde X minutos"
"Limite de envios excedido. Por favor, aguarde X segundos"
```

### Estrutura do Rate Limit

**Tabela: `autenticacao_2fa_rate_limit`**
```sql
CREATE TABLE autenticacao_2fa_rate_limit (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    usuario_id BIGINT NOT NULL UNIQUE,
    ultimo_envio DATETIME,
    tentativas_ultimos_15min INT DEFAULT 0,
    tentativas_ultima_hora INT DEFAULT 0,
    tentativas_hoje INT DEFAULT 0,
    bloqueado_ate DATETIME,
    criado_em DATETIME DEFAULT CURRENT_TIMESTAMP,
    atualizado_em DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## üìÅ Arquivos Modificados/Criados

### 1. Entidade de Rate Limit
**`Autenticacao2FARateLimit.java`**
- Controla limites de envio de c√≥digo
- M√©todos principais:
  - `podeEnviarNovoCodigo()` - Valida se pode enviar
  - `incrementarContadores()` - Atualiza contadores
  - `resetarSeNecessario()` - Reseta janelas expiradas
  - `getTempoEsperaFormatado()` - Mensagem amig√°vel

### 2. Repository
**`Autenticacao2FARateLimitRepository.java`**
```java
Optional<Autenticacao2FARateLimit> findByUsuarioId(Long usuarioId);
boolean existsByUsuarioId(Long usuarioId);
```

### 3. Migration
**`V17__create_2fa_rate_limit.sql`**
- Cria tabela de rate limiting
- √çndice √∫nico em `usuario_id`

### 4. Service: TwoFactorService
**M√©todos Novos:**

#### `verificarRateLimit(Long usuarioId)`
```java
private void verificarRateLimit(Long usuarioId) {
    // Busca ou cria rate limit
    // Reseta contadores se necess√°rio
    // Valida se pode enviar
    // Lan√ßa exce√ß√£o se bloqueado
}
```

#### `incrementarRateLimit(Long usuarioId)`
```java
private void incrementarRateLimit(Long usuarioId) {
    // Incrementa todos os contadores
    // Salva no banco
}
```

#### `ativar2FAAutomaticamente(Long usuarioId, String email)`
```java
@Transactional
public void ativar2FAAutomaticamente(Long usuarioId, String email) {
    // 1. Verifica rate limit
    // 2. Cria/busca configura√ß√£o 2FA
    // 3. Habilita 2FA
    // 4. Gera c√≥digo
    // 5. Envia por email
    // 6. Incrementa rate limit
}
```

**M√©todos Modificados:**

#### `configurar2FA(Long usuarioId)`
```java
// ANTES do envio:
verificarRateLimit(usuarioId);

// DEPOIS do envio:
incrementarRateLimit(usuarioId);
```

#### `enviarCodigoLogin(Long usuarioId)`
```java
// ANTES do envio:
verificarRateLimit(usuarioId);

// DEPOIS do envio:
incrementarRateLimit(usuarioId);
```

### 5. Service: AccountActivationService
**M√©todo Modificado: `ativarConta()`**

```java
@Transactional
public MessageResponseDTO ativarConta(ActivateAccountRequestDTO request) {
    // ... valida√ß√µes e ativa√ß√£o ...
    
    // üÜï NOVO: Ativa 2FA automaticamente
    try {
        log.info("Ativando 2FA automaticamente para usu√°rio ID: {}", usuario.getId());
        twoFactorService.ativar2FAAutomaticamente(usuario.getId(), usuario.getEmail());
        log.info("2FA ativado com sucesso. C√≥digo enviado para: {}", usuario.getEmail());
    } catch (Exception e) {
        log.error("Erro ao ativar 2FA automaticamente: {}", e.getMessage(), e);
        // N√£o interrompe a ativa√ß√£o - 2FA pode ser ativado depois
    }
    
    return MessageResponseDTO.success(
        "Conta ativada com sucesso! 2FA foi habilitado e um c√≥digo de " +
        "verifica√ß√£o foi enviado para seu email. Use-o no pr√≥ximo login."
    );
}
```

**Inje√ß√£o de Depend√™ncia:**
```java
private final TwoFactorService twoFactorService; // NOVO
```

### 6. Service: AuthService
**M√©todo Modificado: `login()`**

```java
public AuthResponseDTO login(LoginRequestDTO request, HttpServletRequest httpRequest) {
    // ... valida√ß√£o de credenciais ...
    
    // üÜï NOVO: Verifica se 2FA est√° habilitado
    if (twoFactorService.usuario2FAHabilitado(usuario.getId())) {
        log.info("Usu√°rio {} tem 2FA habilitado. Enviando c√≥digo...", usuario.getEmail());
        
        try {
            twoFactorService.enviarCodigoLogin(usuario.getId());
        } catch (Exception e) {
            throw new RuntimeException("Erro ao enviar c√≥digo de verifica√ß√£o: " + e.getMessage());
        }
        
        // Retorna resposta SEM token JWT
        return AuthResponseDTO.builder()
                .token(null)
                .requires2FA(true)
                .userId(usuario.getId())
                .message("C√≥digo de verifica√ß√£o enviado para seu email")
                .build();
    }
    
    // Continua login normal se 2FA n√£o habilitado
    // ...
}
```

**Inje√ß√£o de Depend√™ncia:**
```java
private final TwoFactorService twoFactorService; // NOVO
```

### 7. DTO: AuthResponseDTO
**Campos Novos:**

```java
@Data
@Builder
public class AuthResponseDTO {
    private String token;
    private String tipo;
    private String email;
    private String nome;
    private String tipoUsuario;
    private Long expiresIn;
    
    // üÜï NOVOS CAMPOS PARA 2FA
    private Boolean requires2FA;  // Indica se 2FA √© necess√°rio
    private Long userId;          // ID para verifica√ß√£o
    private String message;       // Mensagem adicional
}
```

## üîå Endpoints

### 1. Ativar Conta (com 2FA autom√°tico)
```http
POST /auth/activate
Content-Type: application/json

{
  "token": "abc123...",
  "senhaTemporaria": "SenhaTemp@2024",
  "novaSenha": "MinhaSenha@2024",
  "confirmacaoSenha": "MinhaSenha@2024"
}
```

**Resposta:**
```json
{
  "mensagem": "Conta ativada com sucesso! 2FA foi habilitado e um c√≥digo de verifica√ß√£o foi enviado para seu email. Use-o no pr√≥ximo login.",
  "sucesso": true
}
```

### 2. Login (com 2FA)
```http
POST /auth/login
Content-Type: application/json

{
  "cpf": "12345678901",
  "senha": "MinhaSenha@2024"
}
```

**Resposta (2FA habilitado):**
```json
{
  "token": null,
  "tipo": "Bearer",
  "email": "user@example.com",
  "nome": "Jo√£o Silva",
  "tipoUsuario": "PACIENTE",
  "requires2FA": true,
  "userId": 123,
  "message": "C√≥digo de verifica√ß√£o enviado para seu email"
}
```

### 3. Verificar C√≥digo 2FA
```http
POST /auth/2fa/verify
Content-Type: application/json

{
  "cpf": "12345678901",
  "codigo": "123456"
}
```

**Resposta (sucesso):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "tipo": "Bearer",
  "email": "user@example.com",
  "nome": "Jo√£o Silva",
  "tipoUsuario": "PACIENTE",
  "expiresIn": 86400000,
  "requires2FA": false
}
```

### 4. Reenviar C√≥digo (com rate limiting)
```http
POST /auth/2fa/resend
Authorization: Bearer {token}
```

**Resposta (sucesso):**
```json
{
  "mensagem": "Novo c√≥digo enviado",
  "sucesso": true
}
```

**Resposta (rate limit excedido):**
```json
{
  "mensagem": "Limite de envios excedido. Por favor, aguarde 3 minutos",
  "sucesso": false
}
```

## üß™ Testando

### Teste Manual Completo

1. **Criar usu√°rio:**
```bash
export ADMIN_TOKEN="seu_token_admin"
./test-2fa-automatico.sh
```

2. **O script ir√°:**
   - Criar um usu√°rio
   - Solicitar o token de ativa√ß√£o (do email)
   - Ativar a conta
   - Tentar login (deve pedir c√≥digo 2FA)
   - Solicitar o c√≥digo (do email)
   - Verificar o c√≥digo
   - Testar rate limiting

### Verificar no Banco de Dados

```sql
-- Verificar se 2FA foi ativado
SELECT * FROM autenticacao_2fa WHERE usuario_id = 123;

-- Verificar rate limiting
SELECT * FROM autenticacao_2fa_rate_limit WHERE usuario_id = 123;

-- Ver c√≥digo atual (para testes)
SELECT codigo_atual, expiracao_codigo, habilitado 
FROM autenticacao_2fa 
WHERE usuario_id = 123;
```

## üöÄ Como Funciona na Pr√°tica

### Cen√°rio 1: Primeiro Login Ap√≥s Ativa√ß√£o

```
1. Admin cria usu√°rio
   ‚îî‚îÄ Sistema envia email com senha tempor√°ria

2. Usu√°rio ativa conta
   ‚îú‚îÄ Define nova senha
   ‚îú‚îÄ Sistema ativa 2FA automaticamente ‚úì
   ‚îî‚îÄ Recebe c√≥digo por email

3. Usu√°rio tenta login
   ‚îú‚îÄ Digita CPF e senha
   ‚îú‚îÄ Sistema detecta 2FA habilitado
   ‚îú‚îÄ Envia NOVO c√≥digo
   ‚îî‚îÄ Pede verifica√ß√£o 2FA

4. Usu√°rio verifica c√≥digo
   ‚îú‚îÄ Digita c√≥digo de 6 d√≠gitos
   ‚îî‚îÄ Recebe token JWT
```

### Cen√°rio 2: Rate Limiting em A√ß√£o

```
Usu√°rio tenta reenviar c√≥digo v√°rias vezes:

Tentativa 1 (00:00): ‚úì C√≥digo enviado
Tentativa 2 (00:30): ‚úì C√≥digo enviado  
Tentativa 3 (00:45): ‚úì C√≥digo enviado
Tentativa 4 (01:00): ‚úó "Aguarde 14 minutos" (3/15min)
Tentativa 5 (15:00): ‚úì C√≥digo enviado (reset autom√°tico)
```

## ‚ö†Ô∏è Observa√ß√µes Importantes

### Seguran√ßa

1. **C√≥digo expira em 5 minutos** - Ap√≥s isso, precisa solicitar novo
2. **5 tentativas falhas = bloqueio de 15 minutos** - Prote√ß√£o contra brute force
3. **Rate limiting em 3 janelas** - Previne spam de emails
4. **Intervalo m√≠nimo de 60 segundos** - Entre envios consecutivos

### Logs

Todos os eventos importantes s√£o registrados:

```java
log.info("Ativando 2FA automaticamente para usu√°rio ID: {}", usuarioId);
log.info("üì® Enviando c√≥digo 2FA inicial para: {}", email);
log.warn("Rate limit excedido para usu√°rio ID: {}. Tempo de espera: {}", usuarioId, tempoEspera);
log.error("Erro ao enviar c√≥digo 2FA: {}", e.getMessage());
```

### Exce√ß√µes

Se 2FA falhar durante ativa√ß√£o:
- **Ativa√ß√£o continua** - A conta √© ativada normalmente
- **Usu√°rio pode ativar 2FA depois** - Via endpoint `/auth/2fa/setup`
- **Log registra o erro** - Para investiga√ß√£o

## üìä Diagrama de Fluxo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Admin cria user ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Email enviado           ‚îÇ
‚îÇ (senha tempor√°ria)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Usu√°rio ativa conta     ‚îÇ
‚îÇ /auth/activate          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚ñ∫ Valida token
         ‚îú‚îÄ‚ñ∫ Define senha
         ‚îú‚îÄ‚ñ∫ Ativa conta
         ‚îú‚îÄ‚ñ∫ üÜï Ativa 2FA
         ‚îî‚îÄ‚ñ∫ üÜï Envia c√≥digo
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Email com c√≥digo 2FA    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Usu√°rio tenta login     ‚îÇ
‚îÇ /auth/login             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚ñ∫ Valida senha
         ‚îú‚îÄ‚ñ∫ Detecta 2FA
         ‚îú‚îÄ‚ñ∫ Verifica rate limit ‚ö†Ô∏è
         ‚îî‚îÄ‚ñ∫ Envia c√≥digo
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Retorna:                ‚îÇ
‚îÇ { requires2FA: true }   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Usu√°rio digita c√≥digo   ‚îÇ
‚îÇ /auth/2fa/verify        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚ñ∫ Valida c√≥digo
         ‚îú‚îÄ‚ñ∫ Verifica expira√ß√£o
         ‚îî‚îÄ‚ñ∫ Gera JWT
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úì Login completo!       ‚îÇ
‚îÇ Token JWT retornado     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìù Checklist de Implementa√ß√£o

- [x] Criar entidade `Autenticacao2FARateLimit`
- [x] Criar repository para rate limiting
- [x] Criar migration V17
- [x] Adicionar m√©todos de rate limiting no `TwoFactorService`
- [x] Criar m√©todo `ativar2FAAutomaticamente()`
- [x] Modificar `AccountActivationService.ativarConta()`
- [x] Modificar `AuthService.login()` para detectar 2FA
- [x] Adicionar campos em `AuthResponseDTO`
- [x] Integrar rate limiting em `configurar2FA()`
- [x] Integrar rate limiting em `enviarCodigoLogin()`
- [x] Criar script de teste completo
- [x] Testar fluxo end-to-end
- [x] Testar rate limiting
- [x] Documentar implementa√ß√£o

## üéâ Conclus√£o

A implementa√ß√£o est√° completa e fornece:

1. ‚úÖ **2FA Autom√°tico** - Ativado na ativa√ß√£o da conta
2. ‚úÖ **Rate Limiting** - Prote√ß√£o contra abuso em 3 n√≠veis
3. ‚úÖ **Login Seguro** - Exige c√≥digo em todo login
4. ‚úÖ **Mensagens Claras** - Feedback amig√°vel ao usu√°rio
5. ‚úÖ **Logs Detalhados** - Rastreabilidade completa
6. ‚úÖ **Exce√ß√µes Tratadas** - Falhas n√£o bloqueiam ativa√ß√£o

O sistema est√° pronto para uso em produ√ß√£o! üöÄ
